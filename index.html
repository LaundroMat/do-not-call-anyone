<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do not call -- </title>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"
        integrity="sha256-JLmknTdUZeZZ267LP9qB+/DT7tvxOOKctSKeUC2KT6E=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.1.0/progressbar.min.js"
        integrity="sha512-EZhmSl/hiKyEHklogkakFnSYa5mWsLmTC4ZfvVzhqYNLPbXKAXsjUYRf2O9OlzQN33H0xBVfGSEIUeqt9astHQ=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chance/1.1.7/chance.min.js"
        integrity="sha512-dELYIOEzIECWdvsEdoywFOB4qKDmtQee33yD0dQnzAE7eBGKJ984VQXRLs/vlsP4Sb3VchbQL7iAy4NWqetCsw=="
        crossorigin="anonymous"></script>
    <link href="./tailwind.css" rel="stylesheet">
    <style>
        #progress_indicator_container {
            margin: 20px;
            width: 200px;
            height: 8px;
        }
    </style>
</head>

<body class="container">
    <div x-data="doNotCall()" x-init="init()">
        <div>
            <div class="text-center p-8">
                <div class="text-4xl">
                    Do not call ANYONE
                </div>
                <div class="my-2">
                    <p>
                        Help mee alle Belgen van ongewenste telefoontjes te verlossen.
                    </p>
                </div>
                <div id="" style="position: relative;">
                    <div id="progress_indicator_container" style="position: absolute;">
                    </div>
                </div>
                <div class="">De telefoonnummers van
                    <span class="text-xl font-semibold"
                        x-text="Object.keys(overall_progress).map(area => overall_progress[area].latest | 0).reduce((p1, p2) => p1 + p2, 0)">
                    </span>&nbsp;<span class="text-gray-700">Belgen staan op
                        de do-not-call lijst</span>
                </div>
            </div>
            <div class="button" @click="createDNCMAccount()">
                CREATE ACCOUNT
            </div>
            <p>
                Kies een prefix om automatisch nummers toe te voegen aan de Belgische do-not-call lijst.
            </p>
            <button @click="update_in_progress = false">STOP</button>
            <div class="flex justify-around text-3xl uppercase tracking-widest text-gray-300">
                <div>Grote steden</div>
                <div>Kleine steden</div>
                <div>Mobiele nummers</div>
            </div>
            <div class="flex justify-around">
                <template x-for="area_code_type in Object.keys(area_codes)">
                    <div>
                        <template x-for="area_code in area_codes[area_code_type]">
                            <div class="transition duration-500 ease-in-out shadow-md px-4 py-2 hover:shadow-lg cursor-pointer my-4"
                                @click="addPhoneNumbers(area_code)">
                                <div class="flex gap-x-4 items-center">
                                    <div x-text="area_code" class="text-3xl"></div>
                                    <div class="p-4">
                                        <progress
                                            x-bind:max="area_codes.LARGE_CITY_AREA_CODES.includes(area_code) ? '10000000' : '1000000'"
                                            x-bind:value="area_code in (overall_progress || {}) ? overall_progress[area_code].latest : 1"></progress>
                                    </div>
                                </div>
                                <div class="flex gap-x-2">
                                    <div
                                        x-text="area_code in (overall_progress || {}) ? overall_progress[area_code].latest : 0">
                                    </div>
                                    <div>
                                        /
                                    </div>
                                    <div
                                        x-text="area_codes.LARGE_CITY_AREA_CODES.includes(area_code) ? '10.000.000' : '1.000.000'">
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <div x-show="update_in_progress" class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title"
                role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <!--
              Background overlay, show/hide based on modal state.
        
              Entering: "ease-out duration-300"
                From: "opacity-0"
                To: "opacity-100"
              Leaving: "ease-in duration-200"
                From: "opacity-100"
                To: "opacity-0"
            -->
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true">
                    </div>

                    <!-- This element is to trick the browser into centering the modal contents. -->
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <!--
              Modal panel, show/hide based on modal state.
        
              Entering: "ease-out duration-300"
                From: "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                To: "opacity-100 translate-y-0 sm:scale-100"
              Leaving: "ease-in duration-200"
                From: "opacity-100 translate-y-0 sm:scale-100"
                To: "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            -->
                    <div
                        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div
                                    class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <!-- Heroicon name: outline/exclamation -->
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" />
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        Zone <span x-text="progress_for_area_code.area_code"
                                            class="font-semibold"></span> aan het inschrijven...
                                    </h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500"
                                            x-text="progress_for_area_code.latest && progress_for_area_code.area_code ? lastCreatedPhoneNumber : ''">
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                                @click="update_in_progress = false">
                                Stoppen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>

    <!-- Add SDKs for Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-firestore.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBsbeu2LaSiQbfBB53BRm_scEQ8VCQ4DSg",
            authDomain: "do-not-call-e7284.firebaseapp.com",
            projectId: "do-not-call-e7284",
            storageBucket: "do-not-call-e7284.appspot.com",
            messagingSenderId: "464359768595",
            appId: "1:464359768595:web:0ac08b97908243738b35e6"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
</body>
<script>

    const DEBUG = true

    var db = firebase.firestore();

    // const API_URL = "http://127.0.0.1:5000/"

    const AREA_CODES = {
        LARGE_CITY_AREA_CODES: ["02", "03", "04", "09"],
        SMALL_CITY_AREA_CODES: ["010", "011", "012", "013", "014", "015", "016", "019", "050", "051", "052", "053", "054", "055", "056", "057", "058", "059", "060", "061", "063", "064", "065", "067", "068", "069", "071", "080", "081", "082",
            "083", "084", "085", "086", "087", "089"],
        MOBILE_AREA_CODES: ['0455', '0456', '0457', '0458', '0459', '0460', '04610', '04611', '04612', '04613', '04614', '04615', '04616', '04617', '04618', '04619', '04620', '04621', '04622', '04623', '04624', '04625', '04626', '04627',
            '04628', '04629', '04630', '04631', '04632', '04633', '04634', '04635', '04636', '04637', '04638', '04639', '04640', '04641', '04642', '04643', '04644', '04645', '04646', '04647', '04648', '04649', '04650', '04651',
            '04652', '04653', '04654', '04655', '04656', '04657', '04658', '04659', '04660', '04661', '04662', '04663', '04664', '04665', '04666', '04667', '04668', '04669', '04670', '04671', '04672', '04673', '04674', '04675',
            '04676', '04677', '04678', '04679', '04680', '04681', '04682', '04683', '04684', '04685', '04686', '04687', '04688', '04689', '0469', '0470', '0471', '0472', '0473', '0474', '0475', '0476', '0477', '0478', '0479',
            '04800', '04801', '04802', '04803', '04804', '04805', '04806', '04807', '04808', '04809', '0481', '0482', '0483', '0484', '0485', '0486', '0487', '0488', '0489', '0490', '0491', '0492', '0493', '0494', '0495',
            '0496', '0497', '0498', '0499']
    }


    var bar = new ProgressBar.SemiCircle(progress_indicator_container, {
        strokeWidth: 6,
        color: '#FFEA82',
        trailColor: '#eee',
        trailWidth: 1,
        easing: 'easeInOut',
        duration: 1400,
        svgStyle: null,
        text: {
            value: '',
            alignToBottom: true
        },
        from: { color: '#FFEA82' },
        to: { color: '#ED6A5A' },
        // Set default step function for all animate calls
        step: (state, bar) => {
            bar.path.setAttribute('stroke', state.color);
            var value = bar.value();
            if (value === 0) {
                bar.setText('');
            } else {
                bar.setText(value);
            }

            bar.text.style.color = state.color;
        }
    });
    bar.text.style.fontFamily = '"Raleway", Helvetica, sans-serif';
    bar.text.style.fontSize = '2rem';

    function doNotCall() {
        return {
            area_codes: {},
            dncm_account: {},

            overall_progress: {},   // area_code
            update_in_progress: false,
            progress_for_area_code: {
                latest: 0
            },

            init: async function () {
                // response = await axios.get(API_URL)
                this.area_codes = AREA_CODES
                db.collection("area_codes").onSnapshot((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        // doc.data() is never undefined for query doc snapshots
                        Object.assign(this.overall_progress, { [doc.id]: doc.data() })

                        bar.animate(this.calculateOverallProgressPercentage());
                    });
                })
            },

            calculateOverallProgress: function () {
                return Object.keys(this.overall_progress).map(area => this.overall_progress[area].latest | 0).reduce((p1, p2) => p1 + p2, 0)
            },

            calculateOverallProgressPercentage: function () {
                return this.calculateOverallProgress() / 22000000
            },

            createDNCMAccount: async function () {
                const languages = ['nl', 'fr', 'de', 'en']
                const genders = ['M', 'F']

                const email = chance.email()

                let fake_user_data = {
                    'login': email,
                    'email': email,
                    'pass': chance.string({ length: 12 }),    // (length is 6 - 60 for API). And yes, API requires "pass" here
                    'firstName': chance.first(),
                    'lastName': chance.last(),
                    'language': languages[Math.floor(Math.random() * languages.length)],
                    'gender': genders[Math.floor(Math.random() * genders.length)]
                }

                response = await axios.post('https://www.dncm.be/wp-json/app/v1/consumerregistration', fake_user_data)
                console.debug(response)
                console.debug(response.data)
                Object.assign(this.dncm_account, response.data)

                // Get token too

                response = await axios.post("https://www.dncm.be/wp-json/jwt-auth/v1/token", {
                    username: fake_user_data.login,
                    password: fake_user_data.pass
                })
                console.debug(response)
                console.debug(response.data)
                Object.assign(this.dncm_account, { token: response.data.token })
            },

            addPhoneNumbers: async function (area_code) {

                // response = await axios.post(`${API_URL}account/new`)
                // this.dncm_account = await response.data

                this.update_in_progress = true

                this.progress_for_area_code = {
                    area_code: area_code
                }

                console.debug(JSON.stringify(this.dncm_account))

                // Get latest number for this area code
                db.collection("area_codes").doc(area_code).get().then((doc) => {
                    if (doc.exists) {
                        Object.assign(this.progress_for_area_code, {
                            latest: doc.data().latest
                        })
                    } else {
                        Object.assign(this.progress_for_area_code, {
                            latest: 0
                        })
                    }
                })

                let count = 1
                let self = this

                window.addEventListener("beforeunload", function (evt) {

                    db.collection('area_codes').doc(area_code).set({ latest: self.progress_for_area_code.latest }, merge = true)

                    // Google Chrome requires returnValue to be set
                    // evt.returnValue = '';
                    // delete evt['returnValue']

                    return null;
                }, false);

                while (this.update_in_progress) {

                    components = this.__intToPhoneNumberComponents(this.progress_for_area_code.latest, area_code)

                    post_data = {
                        'area_code': area_code,
                        'auth_token': this.dncm_account.token,
                        'phone_number': `${components.cc}${components.zone}${components.digits}`,
                        'id': this.dncm_account.id,
                    }

                    if (!DEBUG) {
                        response = await axios.post("https://www.dncm.be/wp-json/app/v1/number", post_data, {
                            headers: { Authorization: `Bearer ${this.dncm_account.auth_token}` }
                        })
                    } else {
                        console.info(`Would have posted: ${JSON.stringify(post_data)}`)
                        await new Promise(r => setTimeout(r, 1500));
                    }


                    // TODO: quit when max range passed
                    db.collection('area_codes').doc(area_code).firebase.firestore.FieldValue.increment(1)

                    // // Update DB every 100 (if user closes browser, at least we saved some numbers...)
                    // if (count == 100) {
                    //     db.collection('area_codes').doc(area_code).set({ latest: this.progress_for_area_code.latest }, merge = true)
                    //     count = 0
                    // }
                    // count += 1
                    // Object.assign(this.progress_for_area_code, { latest: this.progress_for_area_code.latest + 1 })
                }
                // Update count
                // db.collection('area_codes').doc(area_code).set({ latest: this.progress_for_area_code.latest }, merge = true)
            },

            __intToPhoneNumberComponents: function (i, area_code) {
                i = i ? i : 0
                let padding = 6 // For 0xx and mobile area codes
                if (this.area_codes.LARGE_CITY_AREA_CODES.includes(area_code)) {
                    padding = 7
                }
                return {
                    'cc': '+32',
                    'zone': area_code.substring(1),
                    'digits': i.toString().padStart(padding, "0")
                }
            },

            get lastCreatedPhoneNumber() {
                components = this.__intToPhoneNumberComponents(this.progress_for_area_code.latest, this.progress_for_area_code.area_code)
                return `${components.cc} ${components.zone} ${components.digits.slice(0, -4)} ${components.digits.slice(-4, -2)} ${components.digits.slice(-2)}`
            }
        }
    }
</script>

</html>